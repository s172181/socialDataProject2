<!DOCTYPE html>
<html lang="en">    
    <head>        
        <meta charset="utf-8">        
        <title>Incidents Responded to by Fire Companies</title>        
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
        <script type="text/javascript" src="d3/d3.js"></script> 
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.0.1/spin.min.js'></script> 
        <link rel="stylesheet" href="css/style.css">
    </head>    
    <body style="text-align:center">  
    
    <!-- Navigation -->
    <nav class="navbar navbar-inverse " >
    <div class="container" >
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <div class="tabbable">
            <ul id="tabsContainer" class="nav nav-pills">
                <li id="lsection1" class="active">
                    <a onclick="changesection(1)" style="cursor:pointer">INCIDENTS PER YEAR</a>
                </li>
                <li id="lsection2">
                    <a onclick="changesection(2)" style="cursor:pointer">TYPES OF INCIDENTS</a>
                </li>
                <li id="lsection3"><a onclick="changesection(3)" style="cursor:pointer">SEVERITY</a></li>
            </ul>
            </div>
        </div>
    </div>
    </nav>

    <div id="container">
       <div id="section1">
        <div id="textinfo"> 
            <div class="box-content"> 
            <div id="titleStory">Example of heather of story</div>
            <div>ELorem ipsum dolor sit amet, consectetur adipiscing elit. In sit amet libero nisi. Nunc pharetra vitae eros quis faucibus. Cras mollis finibus enim vitae tincidunt. Cras tempor ultrices ipsum, sit amet varius odio convallis ut. Duis pellentesque nisi dui, et vehicula eros bibendum sed. Nullam ut tortor sem. Nunc tempor placerat nulla sit amet euismod. Ut varius ut erat eu posuere. Ut eget consequat diam. Quisque sem orci, consectetur a efficitur ut, congue vel libero. Donec ut venenatis augue.</div>
            </div>
        </div>
        <div id="visualizations"> 
            <div id = "graphics">
                <div id="listyear">
                    <ul>
                    <li><a id="l2013" class="listyears selected" onclick="changetimeline('2013')">2013</a></li>
                    <li><a id="l2014" class="listyears" onclick="changetimeline('2014')">2014</a></li>
                    <li><a id="l2015" class="listyears" onclick="changetimeline('2015')">2015</a></li>
                    <li><a id="l2016" class="listyears" onclick="changetimeline('2016')">2016</a></li>
                    <li><a id="l2017" class="listyears" onclick="changetimeline('2017')">2017</a></li>
                    </ul>
                </div>
                <div id="maprest">
                   <div id="mapandtime">
                    <div id="mapgraph" class="centergraphs">
                        
                    </div>    
                    <div id = "timeline" class="centergraphs2 box-content">
                    
                    </div>
                   </div>
                </div>
            </div>
        </div>
      </div>
      <div id="section2" style="display:none">
        <div id="textinfo2"> 
            <div class="box-content"> 
            <div id="titleStory2">Example of 2222</div>
            <div>ELorem ipsum dolor sit amet, consectetur adipiscing elit. In sit amet libero nisi. Nunc pharetra vitae eros quis faucibus. Cras mollis finibus enim vitae tincidunt. Cras tempor ultrices ipsum, sit amet varius odio convallis ut. Duis pellentesque nisi dui, et vehicula eros bibendum sed. Nullam ut tortor sem. Nunc tempor placerat nulla sit amet euismod. Ut varius ut erat eu posuere. Ut eget consequat diam. Quisque sem orci, consectetur a efficitur ut, congue vel libero. Donec ut venenatis augue.</div>
            </div>
        </div>
        <div id="visualizations2"> 
            <div id = "graphics2">
                <div id="listyear2">
                    <ul>
                    <li><a id="l2013" class="listyears selected" onclick="changetimeline('2013')">2013</a></li>
                    <li><a id="l2014" class="listyears" onclick="changetimeline('2014')">2014</a></li>
                    <li><a id="l2015" class="listyears" onclick="changetimeline('2015')">2015</a></li>
                    <li><a id="l2016" class="listyears" onclick="changetimeline('2016')">2016</a></li>
                    <li><a id="l2017" class="listyears" onclick="changetimeline('2017')">2017</a></li>
                    </ul>
                </div>
                <div id="maprest2">
                   <div id="mapandtime2">
                    <div id="mapgraph2" class="centergraphs">
                        
                    </div>    
                    <div id = "timeline2" class="centergraphs2">
                    
                    </div>
                   </div>
                   <div id="incidenttypes2">
                   <div class="box-content"> 
                    <div id="titleStory2">Type of incidents</div>
                    <div>Here list of incidents</div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div id="section3" style="display:none">
        <div id="textinfo3"> 
            <div class="box-content"> 
            <div id="titleStory3">Example of 3333</div>
            <div>ELorem ipsum dolor sit amet, consectetur adipiscing elit. In sit amet libero nisi. Nunc pharetra vitae eros quis faucibus. Cras mollis finibus enim vitae tincidunt. Cras tempor ultrices ipsum, sit amet varius odio convallis ut. Duis pellentesque nisi dui, et vehicula eros bibendum sed. Nullam ut tortor sem. Nunc tempor placerat nulla sit amet euismod. Ut varius ut erat eu posuere. Ut eget consequat diam. Quisque sem orci, consectetur a efficitur ut, congue vel libero. Donec ut venenatis augue.</div>
            </div>
        </div>
        <div id="visualizations3"> 
            <div id = "graphics3">
                <div id="listyear3">
                    <ul>
                    <li><a id="l2013" class="listyears selected" onclick="changetimeline('2013')">2013</a></li>
                    <li><a id="l2014" class="listyears" onclick="changetimeline('2014')">2014</a></li>
                    <li><a id="l2015" class="listyears" onclick="changetimeline('2015')">2015</a></li>
                    <li><a id="l2016" class="listyears" onclick="changetimeline('2016')">2016</a></li>
                    <li><a id="l2017" class="listyears" onclick="changetimeline('2017')">2017</a></li>
                    </ul>
                </div>
                <div id="maprest3">
                   <div id="mapandtime3">
                    <div id="mapgraph3" class="centergraphs">
                        
                    </div>    
                    <div id = "timeline3" class="centergraphs2">
                    
                    </div>
                   </div>
                </div>
            </div>
        </div>
      </div>
    </div>
    
    <div style="position: relative;">    
        <div style="position: absolute; ">
            <a href="explainer.html" style="color: #29b6f6;margin: 0px 15px;cursor:pointer">Go to Explainer page</a>
        </div>
    </div>
    
    <script src="zipCodesIncPop.js"></script>
    <script type="text/javascript"> 
    //Width and height
    var previoussection = 1;
    var w = 600;
    var h = 500;     
    var yearsection1 = "2013";
    
    //For section 1
    var svg = d3.select("#mapgraph")
                .append("svg")
                .attr("width", w)
                .attr("height", h);
    // Define the div for the tooltip
            var div = d3.select("body").append("div")	
                .attr("class", "tooltip")				
                .style("opacity", 0);
                    
    function getSortedKeys(obj) {
            var keys = []; for(var key in obj) keys.push(key);
            return keys.sort(function(a,b){return obj[b]-obj[a]});
        }
    // Spinner while the data is loading
    var opts = {
    	lines: 9, // The number of lines to draw
  		length: 9, // The length of each line
  		width: 5, // The line thickness
  		radius: 18, // The radius of the inner circle
  		color: '#EE3624', // #rgb or #rrggbb or array of colors
  		speed: 1.9, // Rounds per second
  		trail: 40, // Afterglow percentage
  		className: 'spinner', // The CSS class to assign to the spinner
    };
    var targetMap = document.getElementById('mapgraph');
    var spinner = new Spinner(opts).spin(targetMap);
    var targetTimeline = document.getElementById('timeline');
    var spinnerTimeline = new Spinner(opts).spin(targetTimeline);
    //Load in GeoJSON data
    function loaddatamap (ni_choosenYear,ni_choosenYear_op) {
    
        //d3.select("#mapgraph").select("svg").remove();
        
        //Create SVG element
        /*var svg = d3.select("#mapgraph")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);*/
        
        //console.log(target);
        d3.json("nyc-zip-code.json", function(json) {
        	spinnerTimeline.stop();
        	spinner.stop();
            var center = d3.geoCentroid(json); // need this to center the projection correctly
        
            var projection = d3.geoMercator()
                            .center(center)
                            .scale(50000)
                            .translate([(w) / 2, (h)/2]);

            var path = d3.geoPath() //translating GeoJSON coordinates into SVG path codes
                    .projection(projection);
                    
            
            //Bind data and create one path per GeoJSON feature
            //Each one of these Features represents a ZIP code
            //This attribute, d, contains a series of commands and parameters in the SVG Path Mini-Language.
            var nymap = svg.selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path);
            
            loadinfomap(ni_choosenYear,ni_choosenYear_op);

        });
    }
    
    function loadinfomap(ni_choosenYear,ni_choosenYear_op) {
        var nymap = svg.selectAll("path")
        .style("fill", function(d) {
                //Get data value
                var value = d.properties.postalCode;
                //console.log("zip code here "+value.toString()+" - "+ni_choosenYear_op[value.toString()])
                if (typeof ni_choosenYear[value.toString()] === "undefined" || ni_choosenYear[value.toString()]==-1)
                    return "000000";
                return "#EF6C00";
            })
            .style("opacity",function(d) {
                //Get data value
                var value = d.properties.postalCode;
                if (typeof ni_choosenYear[value.toString()] === "undefined" || ni_choosenYear[value.toString()]==-1)
                    return 0.09;
                return ni_choosenYear_op[value.toString()];
            })
            .on("mouseover", function(d) {		
                div.transition()		
                    .duration(200)		
                    .style("opacity", .9);
                //Here we add what we what to put on the tip
                var value = d.properties.postalCode;
                var nIncPer = 0;
                if (typeof ni_choosenYear[value.toString()] === "undefined" || ni_choosenYear[value.toString()]==-1)
                    nIncPer = "N/A";
                else 
                    nIncPer = ni_choosenYear[value.toString()];
                div.html("<h3>Zip code</h3>"+d.properties.postalCode+"<br>"+"<h3>N of incidents</h3>"
                            +nIncPer+"<br>Per 1000 habitants")	
                    .style("left", (d3.event.pageX) + "px")		
                    .style("top", (d3.event.pageY - 28) + "px");	
            // this.style("fill", "#909090");
                var currentState = this;
                d3.select(this).style('fill', "#e1e1e1");
                d3.select(this).style('stroke', "#333333");
                d3.select(this).style('stroke-opacity',  "1");
                })            
            .on("mouseout", function(d) {		
                div.transition()			
                    .style("opacity", 0);	
                var currentState = this;
                var value = d.properties.postalCode;
                d3.select(this).style('stroke', "none");
                if (typeof ni_choosenYear[value.toString()] === "undefined" || ni_choosenYear[value.toString()]==-1) {                
                    d3.select(this).style('opacity',  0.09);
                    d3.select(this).style('fill', "#000000");
                }
                else {
                    d3.select(this).style('opacity',  ni_choosenYear_op[value.toString()]);
                    d3.select(this).style('fill', "#EF6C00");
                }
            });
    }
    
     
     var formatTime = d3.timeFormat("%m");
     /*
     *This function creates the timeline
     */
     function painttimeline(incidentsMonthYear2,mindate,maxdate,incidentsMonthYear_zip2) {
     
        var width = 600;
        var height = 200;
        var padding = 50;
        xScale = d3.scaleTime()
               .domain([
                    mindate,
                    maxdate
                ])
               .range([padding, width]);
               
        var yScale = d3.scaleLinear()
        .domain([0, d3.max(incidentsMonthYear2, function(d) { return d.value; })])
        .range([height - padding, padding]);
        //Define axes
        xAxis = d3.axisBottom()
                .scale(xScale)
                .ticks(12)
                .tickFormat(formatTime);
                
        //Define Y axis
        yAxis = d3.axisLeft()
                .scale(yScale)
                .ticks(3);
                
        //Define line generator
        var line = d3.line()
            .x(function(d) { return xScale(new Date(d.key)); })
            .y(function(d) { return yScale(d.value); });
            
        d3.select("#timeline").select("svg").remove();
        
        //Create SVG element
        var svg2 = d3.select("#timeline")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
            
        //Create line
        var linegraph = svg2.append("path")
        .datum(incidentsMonthYear2)
        .attr("class", "line")
        .attr("d", line)
        .attr("fill", "none")
        .attr("stroke", "steelblue");
        
        //Create axes
        svg2.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (height - padding) + ")")
                .call(xAxis);

        svg2.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(yAxis);
                
        //Define clipping path
        svg2.append("clipPath")                  
            .attr("id", "chart-area")           
            .append("rect")      
            .attr("width", width)
            .attr("height", height-padding);
            
        //Label of the Y axis
        svg2.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0)
            .attr("x",-100)
            .attr("dy", "1em")
            .style("font-size", "11px")
            .style("text-anchor", "middle")
            .style("font-weight", "bold")
            .text("# of Incidents");
            
        //For brush
        var x = d3.scaleLinear().range([0, width]),
        x2 = d3.scaleTime().range([0, width]);
        brush = d3.brushX()
        .extent([[0, padding-1], [width, height-padding]])
        .on('end', highlightlines)
        //.on("brush", highlightlines);
                
        gBrush = svg2.append("g")
        .attr("class", "x brush")
        .attr("clip-path", "url(#chart-area)")   //Add reference to clipPath
        .call(brush);
        
        
        gBrush2 = gBrush.selectAll("rect")
        .attr("y", 1)
        .attr("height", height-padding);
     }
     
     /*
    * Function to 
    */
    function highlightlines() {
        if (!d3.event.selection) return; // Ignore empty selections.
        var d0 = d3.event.selection.map(xScale.invert);
        var aux = new Date(d0[0]); 
        var datet = aux.getFullYear()+'/'+(aux.getMonth()+1)+'/'+aux.getDate();
        
        //Go through the range of dates
        //console.log(incidentsMonthYear_zip[yearsection1][datet]);
        for (var d = d0[0]; d <= d0[1]; d.setDate(d.getDate() + 1)) {
            console.log(new Date(d));
        }
        //for (
    } 
     
     
     function changesection(section) {
        if (previoussection==1) {
            d3.select("#mapgraph").select("svg").remove();
            d3.select("#timeline").select("svg").remove();
        }
        else if (previoussection!=1 && section==1) {
            svg = d3.select("#mapgraph")
                .append("svg")
                .attr("width", w)
                .attr("height", h);
            loaddatamap(zipcodesAll["2013"],totalincAll["2013"]);
            painttimeline(incidentsMonthYear["2013"],mindate["2013"],maxdate["2013"]);
        }
        $("#section"+previoussection).css("display","none");
        $("#section"+section).css("display","block");
        $("#lsection"+previoussection).removeClass("active");
        $("#lsection"+section).addClass("selected");
        previoussection = section;
     }
    
    </script>    
    </body>
</html>