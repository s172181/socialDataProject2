<!DOCTYPE html>
<html lang="en">    
    <head>        
        <meta charset="utf-8">        
        <title>Incidents Responded to by Fire Companies</title>        
        <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>   
        <link rel="stylesheet" href="style.css">
    </head>    
    <body style="text-align:center">     
    <h3>Incidents Responded to by Fire Companies</h3>
    <div id = "graphics">
        <div id="mapgraph" class="centergraphs">
        </div>        
    </div>
    <script type="text/javascript"> 
    //Width and height
    var w = 600;
    var h = 500;
                   
    //Create SVG element
    var svg = d3.select("#mapgraph")
                .append("svg")
                .attr("width", w)
                .attr("height", h);
                
    function getSortedKeys(obj) {
        var keys = []; for(var key in obj) keys.push(key);
        return keys.sort(function(a,b){return obj[b]-obj[a]});
    }

    //read number of zip codes
    //Zip codes and number of incidents
    var zipcodesN = [];
    var totalinc = [];
    d3.csv("zipcodes2017.csv", function(data){
            totalincidents = 0;
            //zipcodesN is an associative array of "zipcode" => total of number of incidents
            //total incidents contains the sum of all incidents
            data.map(function(d){
                   codestring = d.ZIP_CODE;
                   zipcodesN[codestring.toString()] = parseInt(d.Group_Count);
                   totalincidents += parseInt(d.Group_Count);
            });
            //totalinc is an associative array of "zipcode" ==> (total of n incidents)/totalincidents
            // the result is multiplied by a high number to define a higher opacity
            for (var key in zipcodesN) {
                totalinc[key] = parseFloat(zipcodesN[key]/totalincidents)*70;
            }
            loaddatamap();
    })
			
    //Load in GeoJSON data
    function loaddatamap () {
    d3.json("nyc-zip-code.json", function(json) {
    
        var center = d3.geoCentroid(json); // need this to center the projection correctly
    
        var projection = d3.geoMercator()
                        .center(center)
                        .scale(50000)
                        .translate([(w) / 2, (h)/2]);

        var path = d3.geoPath() //translating GeoJSON coordinates into SVG path codes
                .projection(projection);
                
        
        // Define the div for the tooltip
        var div = d3.select("body").append("div")	
            .attr("class", "tooltip")				
            .style("opacity", 0);
                
        //Bind data and create one path per GeoJSON feature
        //Each one of these Features represents a US state or city
        //This attribute, d, contains a series of commands and parameters in the SVG Path Mini-Language.
        var nymap = svg.selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("fill", "#EF6C00")
           .style("opacity",function(d) {
               //Get data value
               var value = d.properties.postalCode;
               return totalinc[value.toString()];
           })
        .on("mouseover", function(d) {		
            div.transition()		
                .duration(200)		
                .style("opacity", .9);
            //Here we add what we what to put on the tip
            var value = d.properties.postalCode;
            div	.html("<b>Zip code<b>:"+d.properties.postalCode+"<br>"+"<b>N of incidents<b>:"
                        +zipcodesN[value.toString()])	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
           // this.style("fill", "#909090");
            var currentState = this;
            d3.select(this).style('fill', "#e1e1e1");
            d3.select(this).style('stroke', "#333333");
            d3.select(this).style('stroke-opacity',  "1");
            })            
        .on("mouseout", function(d) {		
            /*div.transition()		
                .duration(500)		
                .style("opacity", 0);*/	
            var currentState = this;
            var value = d.properties.postalCode;
            d3.select(this).style('stroke', "none");
            d3.select(this).style('opacity',  totalinc[value.toString()]);
            d3.select(this).style('fill', "#EF6C00");
        });
           
       
        

    });
    }
    </script>    
    </body>
</html>
